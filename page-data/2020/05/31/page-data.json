{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/05/31/","result":{"data":{"site":{"siteMetadata":{"title":"Pensando em Códigos"}},"markdownRemark":{"id":"cd42a350-c971-5f6b-94e6-ad5482a99c1d","excerpt":"Um tutorial passando pelos pontos básicos da utilização da biblioteca Bull para gerenciar filas de tarefas assíncronas em aplicações NodeJs. O que é Bull? Bull…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c24d7a53f1ab2b059a7044d186ef5270/0a47e/bull.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.108108108108105%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABXUlEQVQozz3RzStEURzG8dOMhSws5I5BWdlYc2eMLfKSpY2UwsJCpCilGEamlBWlZgZTGG8LL0WUaCZNZO0fIBayYWFjzP353jNn3Pr0e+Z2znPvmat8TXM9GFDmIvtQ7ubK0JJH39yQEhV3KlRCPPCiDKVmev/vmYJ6VKMVe/jCO7qKD6Gsnw05lXCSWCHvYAtXKi5tTBvnxcJJpH32glQFFoUsbnanFYz06UUJGaf0hnmBW0qPcEx+pLCb2YJssfC5KhgVq3E279OF4UK2I2LZ4VxN3XA7i4cp/AVFso4THOoSXeiEkFEvji688zcvu2/0iRQ+8KNnICL+honVkuhbRG3Kk4rnTwtFzoEpvKew1Rw5XXzDa+wjY34vYRTTlj1/qRclZcQc+bxwZDkzshjiAZ14INe6BVOmaAYxNKMDY/8fJZYfVAcibEqxqVdtu1nWsKtSOrt/xTde/wA7m+RfmknkowAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bull\"\n        title=\"bull\"\n        src=\"/static/c24d7a53f1ab2b059a7044d186ef5270/fcda8/bull.png\"\n        srcset=\"/static/c24d7a53f1ab2b059a7044d186ef5270/12f09/bull.png 148w,\n/static/c24d7a53f1ab2b059a7044d186ef5270/e4a3f/bull.png 295w,\n/static/c24d7a53f1ab2b059a7044d186ef5270/fcda8/bull.png 590w,\n/static/c24d7a53f1ab2b059a7044d186ef5270/0a47e/bull.png 600w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p> </p>\n<p>Um tutorial passando pelos pontos básicos da utilização da biblioteca <a href=\"https://github.com/OptimalBits/bull\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bull</a> para gerenciar filas de tarefas assíncronas em aplicações <a href=\"https://nodejs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NodeJs</a>.</p>\n<h2>O que é Bull?</h2>\n<p><a href=\"https://github.com/OptimalBits/bull\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bull</a> é uma biblioteca NodeJS que implementa um rápido e confiável gerenciador de filas de tarefas (<em>job</em>).</p>\n<h4>Filas</h4>\n<p>Fila é uma estrutura de dados muito utilizada no desenvolvimento de aplicações e é definida de forma simples como: o primeiro elemento que entra na fila é o primeiro que sai. O termo que utilizamos em inglês para esse algoritmo é <a href=\"https://pt.wikipedia.org/wiki/FIFO\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">FIFO</a> (<em>first In, first out</em>).</p>\n<p>Filas de tarefas assíncronas são muito utilizadas em arquiteturas de sistemas como forma de delegar tarefas para outros processos e liberar a execução do processo principal. Em aplicações web, o cliente fica aguardando uma requisição http e o servidor pode utilizar uma fila de tarefas para responder a requisição, delegando tarefas demoradas, como envio de emails, para outros sistemas que irão consumir as tarefas da fila.</p>\n<!-- Vantagem do uso de filas: processamento assíncrono, paralelismo, falhas... -->\n<h4>Redis</h4>\n<p><a href=\"https://redis.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Redis</a> é um banco de dados <em>NoSQL</em> muito popular e performático que armazena os dados numa estrutura chave-valor. O Bull utiliza Redis como infraestrutura para controlar e persistir as filas. Assim é necessário o endereço de uma instância Redis no ar.</p>\n<p>Não é necessário entender como Bull usa e persiste as filas no Redis, tudo fica abstraído.</p>\n<h2>Tutorial</h2>\n<p>Nesse tutorial, vamos ver os pontos fundamentais do código relativos ao uso do Bull. Para ver a aplicação completa, veja o projeto <a href=\"https://github.com/giovanibr/bull-demo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bull-demo</a>.</p>\n<h4>Criação da fila</h4>\n<p>O primeiro passo é criar a própria fila de tarefas.</p>\n<p>Importe a biblioteca e instancie uma nova fila passando nos parâmetros o endereço do seu servidor Redis. O construtor <strong>Queue</strong> aceita muitos parâmetros opcionais para customizar o comportamento da fila. Para mais detalhes, veja <a href=\"https://github.com/OptimalBits/bull/blob/develop/REFERENCE.md#queue\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REFERENCE.md#queue</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Queue <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bull'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> minhaFila <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Queue</span><span class=\"token punctuation\">(</span><span class=\"token string\">'minhaFila'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    redis<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        host<span class=\"token operator\">:</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">,</span>\n        port<span class=\"token operator\">:</span> <span class=\"token string\">\"6379\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    prefix<span class=\"token operator\">:</span> <span class=\"token string\">'bulldemo'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>Adicionando trabalhos a fila</h4>\n<p>O segundo passo é definir a inclusão da tarefa na fila. </p>\n<p>A fila criada tem um método <strong>queue.add()</strong> para adicionar tarefas. Esse método recebe um objeto específico de negócio (um email a ser enviado ou um lote a ser processado por exemplo) e também pode receber opções onde é possível programar o comportamento da tarefa na fila como tempo de espera, um numero de tentativas no caso de erro, etc. Para ver mais opções, consultar <a href=\"https://github.com/OptimalBits/bull/blob/develop/REFERENCE.md#queueadd\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REFERENCE.md#queueadd</a>. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    delay<span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 10 seg in ms</span>\n    attempts<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> dadosJob <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token string\">\"numero\"</span><span class=\"token operator\">:</span> <span class=\"token number\">12345</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nminhaFila<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>dadosJob<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>Definição do consumidor</h4>\n<p>O terceiro passo é definir quem vai tratar as tarefas da fila.</p>\n<p>O consumidor é definido por uma função que vai ser chamada toda vez que uma tarefa for retirada da fila de acordo com as configurações. Essa função recebe como parâmetros a tarefa <strong>job</strong>, e o <em>callback</em> opcional <strong>done</strong>.</p>\n<p>A instancia da tarefa contêm todos os dados relativos a sua execução. Os dados que foram passados na criação da tarefa podem ser acessados pela propriedade <strong>job.data</strong>. Para ver todas as propriedades e métodos do objeto, ver <a href=\"https://github.com/OptimalBits/bull/blob/develop/REFERENCE.md#job\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REFERENCE.md#job</a>.</p>\n<p>O <em>callback</em> <strong>done</strong> permite concluir a tarefa com êxito ou com erro, dependendo do que vai ser feito com os dados passados.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">job<span class=\"token punctuation\">,</span> done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//progresso</span>\n    job<span class=\"token punctuation\">.</span><span class=\"token function\">progress</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// chamada de sucesso </span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Feito\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ou chamada de erro</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Deu erro!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// ou erro não tratado, Bull reage do msm jeito</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Erro inesperado'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A função também pode trabalhar com <em>promisses</em> ao invés do <em>callback</em>. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">job</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// sucesso </span>\n        <span class=\"token comment\">//resolve(\"Feito\");</span>\n\n        <span class=\"token comment\">// erro</span>\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Deu erro!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        erro não tratado<span class=\"token punctuation\">,</span> Bull reage <span class=\"token keyword\">do</span> msm jeito\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Erro inesperado'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Definição dos <em>event listeners</em></h4>\n<p>O último passo é definir callbacks para os eventos da fila.</p>\n<p>A fila emite eventos que são muito úteis. Podemos programar ações para cada etapa no ciclo de vida da tarefa (esperando, ativa, finalizada). Podemos também definir o que vai ser feito no caso de erro. </p>\n<p>Para uma lista com todos os eventos, consultar <a href=\"https://github.com/OptimalBits/bull/blob/develop/REFERENCE.md#events\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">REFERENCE.md#events</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//   caminho feliz [waiting, active, completed]</span>\nminhaFila<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'waiting'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">job</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Job recebido!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nminhaFila<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'active'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">job<span class=\"token punctuation\">,</span> jobPromise</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Job começou</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nminhaFila<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'completed'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">job<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>result<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, job finalizado com sucesso</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// remove job da fila</span>\n    job<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nminhaFila<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'failed'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">job<span class=\"token punctuation\">,</span> error</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Job falhou</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// retry</span>\n    job<span class=\"token punctuation\">.</span><span class=\"token function\">retry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Projeto Demo</h2>\n<p>O projeto <a href=\"https://github.com/giovanibr/bull-demo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bull-demo</a> está funcional e imprime no console todos as etapas do ciclo de vida da tarefa. Ele é uma aplicação NodeJS básica com <a href=\"https://expressjs.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Express</a> com um endpoint POST, que recebe os dados da tarefa e coloca na fila.</p>\n<p> </p>","frontmatter":{"title":"Implementando filas de tarefas com Bull","date":"31/05/20","description":"Gerenciando filas assíncronas em projetos NodeJS com Bull."}}},"pageContext":{"slug":"/2020/05/31/","previous":{"fields":{"slug":"/2020/05/18/"},"frontmatter":{"title":"Funções em Javascript: entidades de primeira classe","tags":null}},"next":{"fields":{"slug":"/2020/06/10/"},"frontmatter":{"title":"Usando o AWS S3 com NodeJS","tags":null}}}}}