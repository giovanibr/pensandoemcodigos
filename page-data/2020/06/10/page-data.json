{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/06/10/","result":{"data":{"site":{"siteMetadata":{"title":"Pensando em Códigos"}},"markdownRemark":{"id":"08d15d3f-0283-5f0e-a02e-eeb5d77e180e","excerpt":"Muitas aplicações têm como requisito o armazenamento de arquivos. Podem ser arquivos para download ou a necessidade de gurda de documentos enviados pelo usuário…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 259px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/21f429bb78c18fb85431e27731ce306e/a2ead/s3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAACK0lEQVQoz2P4jwr+/f3778/v///+ff/08fTsyc8WTP/38cNfIPjz5//fv2iKGf5jAJC6//+31pa0ynBfttF601YFMvTfP0yVCM3//oEMvrppzd36kl/7dqxMCmvVlr7ta/uiKPXsmqXbSjLfbVqFZgoDsoOB5MaSzNMW6s/97fc6m3QbqncYqM230GzTkupSEHhckU1A8/baonOups8iPC/72u1zM1tjrz/XUqvbRG2SvsKThlICmrdWF5x1NnoV6bnIWqfNQPFRsPNlP7sOI+WJOrJP64uJ1bzcRrdTX+G2v/1ZH+tOYxWiNAOdfd7N7Fmk5/Ugp5PBLpu8rGdb63Sbqk02UHjaWEpMgKk9C7A/HOB4sijtdnXBLn8HYLB3KfDjDDCgECR67x898GTWxP/XL69MjWrTkLztbf2yNP3uicPHJ3V9OLQHkgr+wVILQjMEgNhgU/Z2N3epil5xNno3qQOiAksigWj4+vXr9evXgYyfP378/vUTaPz3b9+url/5fMPKf79+/PjxHSh188aNS5cu3QYDiH0Mf8FuOH/+fG1t7e7du+fMmbNly5bFixfv2LFj667d2/btX7l69dKlS588ebJv374FCxacOHFiyZIlUM0Qm48ePQpUDVR04cIFIKOzs3PO7NlrV6/evHHDgvnzz5w5A7Tt4sWLQAXbt2/ftWsXip8h9v8BBgYY/Pr16/v37yDnfv/++/dviAU/f/4Ecn+CAUQXAJw30fPn3lg/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aws-s3\"\n        title=\"aws-s3\"\n        src=\"/static/21f429bb78c18fb85431e27731ce306e/a2ead/s3.png\"\n        srcset=\"/static/21f429bb78c18fb85431e27731ce306e/12f09/s3.png 148w,\n/static/21f429bb78c18fb85431e27731ce306e/a2ead/s3.png 259w\"\n        sizes=\"(max-width: 259px) 100vw, 259px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Muitas aplicações têm como requisito o armazenamento de arquivos. Podem ser arquivos para download ou a necessidade de gurda de documentos enviados pelo usuário por exemplo. Hoje em dia existem vários provedores de armazenamento em nuvem como <a href=\"https://aws.amazon.com/pt/s3/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS S3</a>, <a href=\"https://cloud.google.com/storage\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Google Cloud Storage</a>, <a href=\"https://azure.microsoft.com/pt-br/services/storage/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Azure Storage</a> etc.</p>\n<p>A Amazon disponibiliza bibliotecas em várias linguagens para que os desenvolvedores usem os serviços da AWS através de seus sistemas.</p>\n<p>Vamos ver um rápido exemplo em <a href=\"https://nodejs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NodeJs</a> de como fazer download e upload de arquivos para um bucket S3 utilizando o <a href=\"https://github.com/aws/aws-sdk-js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SDK AWS para Javascript</a>.</p>\n<h2>O que é S3</h2>\n<p>S3 ou <em>Simple Storage Service</em> é um serviço de armazenamento de objetos por meio de serviços REST, focado em performance e escalabilidade. Assim, o serviço oferece alta disponibilidade e permite que clientes de todos os tamanhos e com diversas necessidades usufruam do serviço. Os casos de uso possíveis vão desde backup a guarda de documentos para sites e aplicativos.</p>\n<p>Para o armazenamento, a Amazon usa o conceito de <strong><em>bucket</em></strong>, que nada mais é que um recipiente para os objetos armazenados. Podem ser criados quantos buckets forem necessários e eles oferecem controle de acesso individual e logs de acesso. Também é possível escolher a região geográfica onde os objetos são armazenados.</p>\n<p>Ao armazenar um objeto, é necessário criar uma chave (<strong><em>key</em></strong>) associada, para depois recuperá-lo.</p>\n<h2>Vamos ao código</h2>\n<p>O primeiro passo é importar a biblioteca AWS e configurar as credenciais de acesso ao AWS.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> aws <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\naws<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n accessKeyId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">S3_ACCESS_KEY</span><span class=\"token punctuation\">,</span>\n secretAccessKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">S3_ACCESS_SECRET</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>Upload</h4>\n<p>Para o upload, criamos um objeto com os parâmetros que devem ser passados para a função <strong>upload</strong> da sdk. Devemos passar:</p>\n<ul>\n<li>Bucket: string que representa o nome do bucket (o bucket já deve ter sido criado)</li>\n<li>Body: um objeto do tipo <a href=\"https://nodejs.org/api/stream.html#stream_readable_streams\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Readable Stream</a>. No caso estamos criando esse stream a partir do caminho físico do arquivo.</li>\n<li>Key: string que representa a chave. O arquivo criado vai ter o nome da chave e no caso abaixo estamos criando o arquivo na pasta ‘s3-demo’.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Bucket<span class=\"token operator\">:</span> <span class=\"token string\">'nomeDoBucket'</span><span class=\"token punctuation\">,</span>\n  Body <span class=\"token operator\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./teste1.txt'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  Key <span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">s3-demo/teste1.txt</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Para executar o upload primeiro criamos o objeto S3 chamando seu construtor e depois chamamos a <a href=\"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#upload-property\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">função</a> disponível na interface <a href=\"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">S3</a>. Se a operação for bem sucedida, recebemos no callback o objeto data com várias informações do objeto armazenado, incluindo um link direto para acesso.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> s3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws<span class=\"token punctuation\">.</span>S3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ns3<span class=\"token punctuation\">.</span><span class=\"token function\">upload</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Erro: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// sucesso</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Uploaded em: \"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>Location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Chave: \"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4>Download</h4>\n<p>Para o download precisamos passar como parâmetro o nome do bucket e a chave.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    Bucket<span class=\"token operator\">:</span> <span class=\"token string\">'nomeDoBucket'</span><span class=\"token punctuation\">,</span>\n    Key<span class=\"token operator\">:</span> <span class=\"token string\">'s3-demo/teste1.txt'</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Para executar o download também fazemos uso da interface S3 para chamar a <a href=\"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#getObject-property\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">função</a>. Se a operação for bem sucedida, recebemos o arquivo serializado, bastando criar um <a href=\"https://nodejs.org/api/stream.html#stream_writable_streams\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Writable Stream</a> e gravar o arquivo em disco.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> s3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws<span class=\"token punctuation\">.</span>S3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createWriteStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/tmp/test.csv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ns3<span class=\"token punctuation\">.</span><span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createReadStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfileStream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Projeto Demo</h2>\n<p>O projeto <a href=\"https://github.com/giovanibr/aws-node-demo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">aws-node-demo</a> é uma aplicação NodeJS básica com <a href=\"https://expressjs.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Express</a> que disponibiliza 2 endpoints para upload e download na AWS.</p>\n<p> </p>","frontmatter":{"title":"Usando o AWS S3 com NodeJS","date":"10/06/20","description":"Como fazer upload e download de arquivos na Amazon S3 usando NodeJS."}}},"pageContext":{"slug":"/2020/06/10/","tag":"post","previous":{"fields":{"slug":"/2020/05/31/"},"frontmatter":{"title":"Implementando filas de tarefas com Bull","tag":"post"}},"next":{"fields":{"slug":"/2020/06/21/"},"frontmatter":{"title":"Leituras mais interessantes da semana","tag":"post"}}}}}